metrics-generator: aggregated-metrics
# Aggregated metrics are calculated based on the metrics that are already calculated.
snapshot-metrics:
  global:
  - metric: delta_packages_avg
    query: |
      WITH before AS (
        SELECT 
          AVG(nodes)        AS nodes,
          AVG(classes)      AS classes,
          AVG(abstracts)    AS abstracts,
          AVG(interfaces)   AS interfaces,
          AVG(efferent)     AS efferent,
          AVG(afferent)     AS afferent,
          AVG(instability)  AS instability,
          AVG(package_abstractness) AS package_abstractness,
          AVG(package_distance_from_main_sequence) AS d_f_main_size
        FROM packages
        WHERE time = 'before'
      ),
      after AS (
        SELECT 
          AVG(nodes)        AS nodes,
          AVG(classes)      AS classes,
          AVG(abstracts)    AS abstracts,
          AVG(interfaces)   AS interfaces,
          AVG(efferent)     AS efferent,
          AVG(afferent)     AS afferent,
          AVG(instability)  AS instability,
          AVG(package_abstractness) AS package_abstractness,
          AVG(package_distance_from_main_sequence) AS d_f_main_size
        FROM packages
        WHERE time = 'after'
      )
      SELECT
        after.nodes - before.nodes AS _nodes,
        after.classes - before.classes AS _classes,
        after.abstracts - before.abstracts AS _abstracts,
        after.interfaces - before.interfaces AS _interfaces,
        after.efferent - before.efferent AS _efferent,
        after.afferent - before.afferent AS _afferent,
        after.instability - before.instability AS _instability,
        after.package_abstractness - before.package_abstractness AS _package_abstractness,
        after.d_f_main_size - before.d_f_main_size AS _d_f_main_size
      FROM before, after;
  - metric: delta_packages_max
    query: |
      WITH before AS (
        SELECT 
          MAX(nodes)        AS nodes,
          MAX(classes)      AS classes,
          MAX(abstracts)    AS abstracts,
          MAX(interfaces)   AS interfaces,
          MAX(efferent)     AS efferent,
          MAX(afferent)     AS afferent,
          MAX(instability)  AS instability,
          MAX(package_abstractness) AS package_abstractness,
          MAX(package_distance_from_main_sequence) AS d_f_main_size
        FROM packages
        WHERE time = 'before'
      ),
      after AS (
        SELECT 
          MAX(nodes)        AS nodes,
          MAX(classes)      AS classes,
          MAX(abstracts)    AS abstracts,
          MAX(interfaces)   AS interfaces,
          MAX(efferent)     AS efferent,
          MAX(afferent)     AS afferent,
          MAX(instability)  AS instability,
          MAX(package_abstractness) AS package_abstractness,
          MAX(package_distance_from_main_sequence) AS d_f_main_size
        FROM packages
        WHERE time = 'after'
      )
      SELECT
        after.nodes - before.nodes AS _nodes,
        after.classes - before.classes AS _classes,
        after.abstracts - before.abstracts AS _abstracts,
        after.interfaces - before.interfaces AS _interfaces,
        after.efferent - before.efferent AS _efferent,
        after.afferent - before.afferent AS _afferent,
        after.instability - before.instability AS _instability,
        after.package_abstractness - before.package_abstractness AS _package_abstractness,
        after.d_f_main_size - before.d_f_main_size AS _d_f_main_size
      FROM before, after;
  - metric: delta_packages_stdev
    query: |
      WITH before AS (
        SELECT 
          stdev(nodes)        AS nodes,
          stdev(classes)      AS classes,
          stdev(abstracts)    AS abstracts,
          stdev(interfaces)   AS interfaces,
          stdev(efferent)     AS efferent,
          stdev(afferent)     AS afferent,
          stdev(instability)  AS instability,
          stdev(package_abstractness) AS package_abstractness,
          stdev(package_distance_from_main_sequence) AS d_f_main_size
        FROM packages
        WHERE time = 'before'
      ),
      after AS (
        SELECT 
          stdev(nodes)        AS nodes,
          stdev(classes)      AS classes,
          stdev(abstracts)    AS abstracts,
          stdev(interfaces)   AS interfaces,
          stdev(efferent)     AS efferent,
          stdev(afferent)     AS afferent,
          stdev(instability)  AS instability,
          stdev(package_abstractness) AS package_abstractness,
          stdev(package_distance_from_main_sequence) AS d_f_main_size
        FROM packages
        WHERE time = 'after'
      )
      SELECT
        after.nodes - before.nodes AS _nodes,
        after.classes - before.classes AS _classes,
        after.abstracts - before.abstracts AS _abstracts,
        after.interfaces - before.interfaces AS _interfaces,
        after.efferent - before.efferent AS _efferent,
        after.afferent - before.afferent AS _afferent,
        after.instability - before.instability AS _instability,
        after.package_abstractness - before.package_abstractness AS _package_abstractness,
        after.d_f_main_size - before.d_f_main_size AS _d_f_main_size
      FROM before, after;
  - metric: delta_classes_avg
    query: |
      WITH before AS (
        SELECT 
          AVG(abstracts_deps_count) AS abstracts_deps_count,
          AVG(concrete_deps_count)  AS concrete_deps_count,
          AVG(afferent_count)       AS afferent_count,
          AVG(efferent_count)       AS efferent_count,
          AVG(instability_class)    AS instability_class
        FROM classes
        WHERE time = 'before'
      ),
      after AS (
        SELECT 
          AVG(abstracts_deps_count) AS abstracts_deps_count,
          AVG(concrete_deps_count)  AS concrete_deps_count,
          AVG(afferent_count)       AS afferent_count,
          AVG(efferent_count)       AS efferent_count,
          AVG(instability_class)    AS instability_class
        FROM classes
        WHERE time = 'after'
      )
      SELECT
        after.abstracts_deps_count - before.abstracts_deps_count AS _abstracts_deps_count,
        after.concrete_deps_count  - before.concrete_deps_count  AS _concrete_deps_count,
        after.afferent_count       - before.afferent_count       AS _afferent_count,
        after.efferent_count       - before.efferent_count       AS _efferent_count,
        after.instability_class    - before.instability_class    AS _instability_class
      FROM before, after;
  - metric: delta_classes_max
    query: |
      WITH before AS (
        SELECT 
          MAX(abstracts_deps_count) AS abstracts_deps_count,
          MAX(concrete_deps_count)  AS concrete_deps_count,
          MAX(afferent_count)       AS afferent_count,
          MAX(efferent_count)       AS efferent_count,
          MAX(instability_class)    AS instability_class
        FROM classes
        WHERE time = 'before'
      ),
      after AS (
        SELECT 
          MAX(abstracts_deps_count) AS abstracts_deps_count,
          MAX(concrete_deps_count)  AS concrete_deps_count,
          MAX(afferent_count)       AS afferent_count,
          MAX(efferent_count)       AS efferent_count,
          MAX(instability_class)    AS instability_class
        FROM classes
        WHERE time = 'after'
      )
      SELECT
        after.abstracts_deps_count - before.abstracts_deps_count AS _abstracts_deps_count,
        after.concrete_deps_count  - before.concrete_deps_count  AS _concrete_deps_count,
        after.afferent_count       - before.afferent_count       AS _afferent_count,
        after.efferent_count       - before.efferent_count       AS _efferent_count,
        after.instability_class    - before.instability_class    AS _instability_class
      FROM before, after;
  - metric: delta_classes_stdev
    query: |
      WITH before AS (
        SELECT 
          STDEV(abstracts_deps_count) AS abstracts_deps_count,
          STDEV(concrete_deps_count)  AS concrete_deps_count,
          STDEV(afferent_count)       AS afferent_count,
          STDEV(efferent_count)       AS efferent_count,
          STDEV(instability_class)    AS instability_class
        FROM classes
        WHERE time = 'before'
      ),
      after AS (
        SELECT 
          STDEV(abstracts_deps_count) AS abstracts_deps_count,
          STDEV(concrete_deps_count)  AS concrete_deps_count,
          STDEV(afferent_count)       AS afferent_count,
          STDEV(efferent_count)       AS efferent_count,
          STDEV(instability_class)    AS instability_class
        FROM classes
        WHERE time = 'after'
      )
      SELECT
        after.abstracts_deps_count - before.abstracts_deps_count AS _abstracts_deps_count,
        after.concrete_deps_count  - before.concrete_deps_count  AS _concrete_deps_count,
        after.afferent_count       - before.afferent_count       AS _afferent_count,
        after.efferent_count       - before.efferent_count       AS _efferent_count,
        after.instability_class    - before.instability_class    AS _instability_class
      FROM before, after;
  per-class:
  per-package:
delta-metrics:
  global:
  per-class:
  per-package:

